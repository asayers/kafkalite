<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Database.Kafkar</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Database-Kafkar.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Database-Kafkar.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">kafkar-0.1.0.0: Read-only support for the Kafka on-disk format</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Database.Kafkar</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Core API</a></li><li><a href="#g:2">Types</a></li><li><a href="#g:3">Pretty-printing</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Read-only support for the Kafka on-disk format, no broker required!</p><p>This module provides access to Kafka streams which are accessible
 directly on the local disk, without requiring a Kafka server. It
 contains a parser for the Kafka on-disk log format, some logic for
 seeking using Kafka's index files, and some logic for extracting
 compressed streams. The idea is to provide an interface which is similar
 to the one exposed by a real Kafka server, so that it shouldn't be too
 tricky to transparently switch between online and offline access to
 your Kafka data.</p><h2>Usage</h2><pre>import Database.Kafkar
import Pipes
import Pipes.Safe
import qualified Pipes.Prelude as P

main :: IO ()
main = do
    -- Read in and parse all index files for &quot;myTopic&quot;
    topic &lt;- loadTopic &quot;/var/lib/kafka&quot; &quot;myTopic&quot; 0

    -- Read messages 1000-1009 from the topic. msgs :: [MessageEntry]
    msgs &lt;- runSafeT $ P.toList $
        readTopic topic (Offset 1000) &gt;-&gt; P.take 10

    -- Stream messages from the topic, starting at the beginning of
    -- the stream, and pretty-print them to stdout
    runSafeT $ runEffect $
       readTopic topic (Offset 0) &gt;-&gt; P.map ppMessage &gt;-&gt; P.stdoutLn</pre><h2>Operational properties</h2><p>Memory use is constant-ish, but beware:</p><ul><li>In the case of uncompressed streams, it depends on the size of the
   messages;</li><li>In the case of compressed streams, it depends on the uncompressed size
   of a batch of messages;</li><li>All indices are loaded into memory. The amount of memory required for
   this depends on the density of the indices (configurable) and the
   total size of the stream in bytes. This behaviour could be improved by
   only loading indices when seeking, and releasing them when the seek is
   complete.</li></ul><p>Files are opened only when needed and are closed promptly. When
 streaming across a segment boundary, for instance, the first segment's
 log file is closed as the second segment's log file is opened.</p><h2>Is this a good idea?</h2><p>The Kafka on-disk format has never been advertised as a stable, portable
 format. It is essentially undocumented; writing this package required
 some mild reverse-engineering. In light of this, is it a good idea to
 try to read these things directly?</p><p>Kafka makes the clever design decision of keeping data on-disk in
 exactly the format which it must be sent in. That is, it sits on the
 disk, compressed and annotated with metadata, all ready to be sent to
 a client. This means that Kafka can respond to data requests with
 a simple (and fast) call to `sendFile()`.</p><p>The upshot of this is that the on-disk format must be as stable as the
 wire format. Since this is a well-documented, properly versioned format
 which comes with commitments to backward-compatibility, it's safe to say
 that the on-disk format is likewise stable (barring major changes to
 Kafka's design).</p><p>I should note that the above argument applies only to the format of the
 log data. The index files are not exposed by any public interface, and
 so may change. In this case, seeking will break.</p><h2>Other caveats</h2><ul><li>Kafka only flushes its logs to disk periodically. This means that new
   messages in a topic will be absent from the on-disk logs for some
   amount of time.</li></ul></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><a href="#v:loadTopic">loadTopic</a> :: <a href="../base-4.8.1.0/System-IO.html#t:FilePath">FilePath</a> -&gt; <a href="../base-4.8.1.0/Data-String.html#t:String">String</a> -&gt; <a href="../base-4.8.1.0/Data-Int.html#t:Int">Int</a> -&gt; <a href="../base-4.8.1.0/System-IO.html#t:IO">IO</a> Topic</li><li class="src short"><a href="#v:readTopic">readTopic</a> :: <a href="../pipes-safe-2.2.3/Pipes-Safe.html#t:MonadSafe">MonadSafe</a> m =&gt; Topic -&gt; <a href="Database-Kafkar.html#t:Offset">Offset</a> -&gt; <a href="../pipes-4.1.7/Pipes-Core.html#t:Producer">Producer</a> <a href="Database-Kafkar.html#t:MessageEntry">MessageEntry</a> m ()</li><li class="src short"><span class="keyword">data</span> <a href="#t:MessageEntry">MessageEntry</a> = <a href="#v:MessageEntry">MessageEntry</a> {<ul class="subs"><li><a href="#v:offset">offset</a> :: !<a href="Database-Kafkar.html#t:Offset">Offset</a></li><li><a href="#v:size">size</a> :: !<a href="../base-4.8.1.0/Data-Int.html#t:Int32">Int32</a></li><li><a href="#v:message">message</a> :: !<a href="Database-Kafkar.html#t:Message">Message</a></li></ul>}</li><li class="src short"><span class="keyword">data</span> <a href="#t:Message">Message</a> = <a href="#v:Message">Message</a> {<ul class="subs"><li><a href="#v:attributes">attributes</a> :: !<a href="Database-Kafkar.html#t:Attributes">Attributes</a></li><li><a href="#v:key">key</a> :: !(<a href="../base-4.8.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../bytestring-0.10.6.0/Data-ByteString.html#t:ByteString">ByteString</a>)</li><li><a href="#v:value">value</a> :: !(<a href="../base-4.8.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../bytestring-0.10.6.0/Data-ByteString.html#t:ByteString">ByteString</a>)</li></ul>}</li><li class="src short"><span class="keyword">data</span> <a href="#t:Attributes">Attributes</a> = <a href="#v:Attributes">Attributes</a> {<ul class="subs"><li><a href="#v:compression">compression</a> :: !<a href="Database-Kafkar.html#t:Codec">Codec</a></li></ul>}</li><li class="src short"><span class="keyword">data</span> <a href="#t:Codec">Codec</a><ul class="subs"><li>= <a href="#v:None">None</a></li><li>| <a href="#v:GZip">GZip</a></li><li>| <a href="#v:Snappy">Snappy</a></li></ul></li><li class="src short"><span class="keyword">newtype</span> <a href="#t:Offset">Offset</a> = <a href="#v:Offset">Offset</a> <a href="../base-4.8.1.0/Data-Int.html#t:Int64">Int64</a></li><li class="src short"><a href="#v:ppMessage">ppMessage</a> :: <a href="Database-Kafkar.html#t:MessageEntry">MessageEntry</a> -&gt; <a href="../base-4.8.1.0/Data-String.html#t:String">String</a></li></ul></div><div id="interface"><h1 id="g:1">Core API</h1><div class="top"><p class="src"><a name="v:loadTopic" class="def">loadTopic</a> <a href="src/Database-Kafkar.html#loadTopic" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="../base-4.8.1.0/System-IO.html#t:FilePath">FilePath</a></td><td class="doc"><p>Kafka log directory (eg. /var/lib/kafka)</p></td></tr><tr><td class="src">-&gt; <a href="../base-4.8.1.0/Data-String.html#t:String">String</a></td><td class="doc"><p>Topic name</p></td></tr><tr><td class="src">-&gt; <a href="../base-4.8.1.0/Data-Int.html#t:Int">Int</a></td><td class="doc"><p>Partition number</p></td></tr><tr><td class="src">-&gt; <a href="../base-4.8.1.0/System-IO.html#t:IO">IO</a> Topic</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Create a handle for a topic/partition stored on the filesystem.</p><p>This function will read all index files for the given topic into memory
 (~10KB per segment). It will not read any log data. The returned value
 should not contain any thunks.</p></div></div><div class="top"><p class="src"><a name="v:readTopic" class="def">readTopic</a> <a href="src/Database-Kafkar.html#readTopic" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="../pipes-safe-2.2.3/Pipes-Safe.html#t:MonadSafe">MonadSafe</a> m</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; Topic</td><td class="doc"><p>Topic handle to read from</p></td></tr><tr><td class="src">-&gt; <a href="Database-Kafkar.html#t:Offset">Offset</a></td><td class="doc"><p>Offset to begin reading at, given as a number of
   messages since the start of the topic.</p></td></tr><tr><td class="src">-&gt; <a href="../pipes-4.1.7/Pipes-Core.html#t:Producer">Producer</a> <a href="Database-Kafkar.html#t:MessageEntry">MessageEntry</a> m ()</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Stream messages from the given topic, starting at the given offset.</p><p>This function uses the Kafka index to perform an efficient seek to the
 desired offset. Given that the index is in memory, a seek should require
 reading a bounded number of bytes (determined by the density of the
 index).</p><p>It then streams messages from the log file, parsing and decompressing
 them. The <code><a href="Database-Kafkar.html#v:compression">compression</a></code> attribute should always be <code><a href="Database-Kafkar.html#v:None">None</a></code> for messages
 returned by this function.</p><p>Kafka logs are stored in multiple segments. This function should only
 hold a read handle for one segment file at a time.</p></div></div><h1 id="g:2">Types</h1><div class="top"><p class="src"><span class="keyword">data</span> <a name="t:MessageEntry" class="def">MessageEntry</a> <a href="src/Database-Kafkar-Types.html#MessageEntry" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:MessageEntry" class="def">MessageEntry</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:offset" class="def">offset</a> :: !<a href="Database-Kafkar.html#t:Offset">Offset</a></dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:size" class="def">size</a> :: !<a href="../base-4.8.1.0/Data-Int.html#t:Int32">Int32</a></dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:message" class="def">message</a> :: !<a href="Database-Kafkar.html#t:Message">Message</a></dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div><div class="subs instances"><p id="control.i:MessageEntry" class="caption collapser" onclick="toggleSection('i:MessageEntry')">Instances</p><div id="section.i:MessageEntry" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Data-Eq.html#t:Eq">Eq</a> <a href="Database-Kafkar.html#t:MessageEntry">MessageEntry</a></span> <a href="src/Database-Kafkar-Types.html#line-95" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Text-Show.html#t:Show">Show</a> <a href="Database-Kafkar.html#t:MessageEntry">MessageEntry</a></span> <a href="src/Database-Kafkar-Types.html#line-95" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a name="t:Message" class="def">Message</a> <a href="src/Database-Kafkar-Types.html#Message" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Message" class="def">Message</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:attributes" class="def">attributes</a> :: !<a href="Database-Kafkar.html#t:Attributes">Attributes</a></dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:key" class="def">key</a> :: !(<a href="../base-4.8.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../bytestring-0.10.6.0/Data-ByteString.html#t:ByteString">ByteString</a>)</dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:value" class="def">value</a> :: !(<a href="../base-4.8.1.0/Data-Maybe.html#t:Maybe">Maybe</a> <a href="../bytestring-0.10.6.0/Data-ByteString.html#t:ByteString">ByteString</a>)</dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div><div class="subs instances"><p id="control.i:Message" class="caption collapser" onclick="toggleSection('i:Message')">Instances</p><div id="section.i:Message" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Data-Eq.html#t:Eq">Eq</a> <a href="Database-Kafkar.html#t:Message">Message</a></span> <a href="src/Database-Kafkar-Types.html#line-101" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Text-Show.html#t:Show">Show</a> <a href="Database-Kafkar.html#t:Message">Message</a></span> <a href="src/Database-Kafkar-Types.html#line-101" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a name="t:Attributes" class="def">Attributes</a> <a href="src/Database-Kafkar-Types.html#Attributes" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Attributes" class="def">Attributes</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:compression" class="def">compression</a> :: !<a href="Database-Kafkar.html#t:Codec">Codec</a></dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div><div class="subs instances"><p id="control.i:Attributes" class="caption collapser" onclick="toggleSection('i:Attributes')">Instances</p><div id="section.i:Attributes" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Data-Eq.html#t:Eq">Eq</a> <a href="Database-Kafkar.html#t:Attributes">Attributes</a></span> <a href="src/Database-Kafkar-Types.html#line-105" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Text-Show.html#t:Show">Show</a> <a href="Database-Kafkar.html#t:Attributes">Attributes</a></span> <a href="src/Database-Kafkar-Types.html#line-105" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a name="t:Codec" class="def">Codec</a> <a href="src/Database-Kafkar-Types.html#Codec" class="link">Source</a></p><div class="doc"><p>Message compression algorithm</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:None" class="def">None</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:GZip" class="def">GZip</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Snappy" class="def">Snappy</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="subs instances"><p id="control.i:Codec" class="caption collapser" onclick="toggleSection('i:Codec')">Instances</p><div id="section.i:Codec" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Data-Eq.html#t:Eq">Eq</a> <a href="Database-Kafkar.html#t:Codec">Codec</a></span> <a href="src/Database-Kafkar-Types.html#line-42" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Text-Show.html#t:Show">Show</a> <a href="Database-Kafkar.html#t:Codec">Codec</a></span> <a href="src/Database-Kafkar-Types.html#line-42" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><span class="keyword">newtype</span> <a name="t:Offset" class="def">Offset</a> <a href="src/Database-Kafkar-Types.html#Offset" class="link">Source</a></p><div class="doc"><p>The logical offset of a message within a topic</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Offset" class="def">Offset</a> <a href="../base-4.8.1.0/Data-Int.html#t:Int64">Int64</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="subs instances"><p id="control.i:Offset" class="caption collapser" onclick="toggleSection('i:Offset')">Instances</p><div id="section.i:Offset" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Data-Eq.html#t:Eq">Eq</a> <a href="Database-Kafkar.html#t:Offset">Offset</a></span> <a href="src/Database-Kafkar-Types.html#line-46" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Data-Ord.html#t:Ord">Ord</a> <a href="Database-Kafkar.html#t:Offset">Offset</a></span> <a href="src/Database-Kafkar-Types.html#line-46" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><a href="../base-4.8.1.0/Text-Show.html#t:Show">Show</a> <a href="Database-Kafkar.html#t:Offset">Offset</a></span> <a href="src/Database-Kafkar-Types.html#line-46" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><a href="../vector-space-0.10.2/Data-AffineSpace.html#t:AffineSpace">AffineSpace</a> <a href="Database-Kafkar.html#t:Offset">Offset</a></span> <a href="src/Database-Kafkar-Types.html#line-61" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="keyword">type</span> <a href="../vector-space-0.10.2/Data-AffineSpace.html#t:Diff">Diff</a> <a href="Database-Kafkar.html#t:Offset">Offset</a></span> <a href="src/Database-Kafkar-Types.html#line-62" class="link">Source</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><h1 id="g:3">Pretty-printing</h1><div class="top"><p class="src"><a name="v:ppMessage" class="def">ppMessage</a> :: <a href="Database-Kafkar.html#t:MessageEntry">MessageEntry</a> -&gt; <a href="../base-4.8.1.0/Data-String.html#t:String">String</a> <a href="src/Database-Kafkar.html#ppMessage" class="link">Source</a></p><div class="doc"><p>Pretty-print a message in the format</p><pre>&lt;offset&gt;: [key:] &lt;value&gt;</pre></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.16.1</p></div></body></html>